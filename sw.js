(()=>{const e="kmarBlogCache",t="https://id.v3/",n=()=>caches.match(t).then((e=>e?.json())),s=n=>caches.open(e).then((e=>e.put(t,new Response(JSON.stringify(n)))));self.addEventListener("install",(()=>{self.skipWaiting()})),self.addEventListener("activate",(e=>e.waitUntil(clients.claim())));const a=l,r=e=>e.ok||[301,302,307,308].includes(e.status),c=new Map;self.addEventListener("fetch",(t=>{let n=t.request,s=new URL(n.url);if("GET"!==n.method||!n.url.startsWith("http"))return;let h,l=s.hostname+s.pathname+s.search;const u=e=>{t.respondWith(h?e.then((e=>{for(let t of h)t(e.clone())})).catch((e=>{for(let t of h)t(e)})).then((()=>(c.delete(l),e))):e)},f=i(s);if(f){let t=`https://${s.host}${s.pathname}`;t.endsWith("/index.html")&&(t=t.substring(0,t.length-10)),f.search&&(t+=s.search),u(caches.match(t).then((s=>s??a(n,!0).then((n=>{if(r(n)){const s=n.clone();caches.open(e).then((e=>e.put(t,s)))}return n})))))}else{const e=null;u(e?a(n,!1,e):o(n).catch((e=>new Response(e,{status:499}))))}})),self.addEventListener("message",(e=>{"update"===e.data&&u().then((t=>{t.type="update",e.source.postMessage(t)}))}));const h=(e,t,n,s)=>(s||(s={}),s.cache=t?"no-store":"default",n&&(s.mode="cors",s.credentials="same-origin"),fetch(e,s)),o=(e,t)=>h(e,!1,!1,t),l=(e,t,n)=>h(e,t,!0,n),i=e=>{if("localhost"!==e.hostname)for(let t in cacheRules){const n=cacheRules[t];if(n.match(e))return n}},u=async()=>{const c=await a(new Request("/update.json"),!1);if(!r(c))throw`加载 update.json 时遇到异常，状态码：${c.status}`;const h=await c.json(),o=await(e=>n().then((t=>{const{info:n,global:a}=e,r={global:a,local:n[0].version,escape:t?.escape??0};if(!t)return r.escape=0,s(r),{new:r,old:t};let c=new f,h=((e,t,n)=>{for(let s of t){const{version:t,change:a}=s;if(t===n)return!1;if(a)for(let t of a)e.push(new p(t))}return!0})(c,n,t.local);return s(r),h&&(a!==t.global?c.force=!0:c.refresh=!0),{list:c,new:r,old:t}})))(h);if(o.list){const n=await(n=>caches.open(e).then((e=>e.keys().then((s=>Promise.all(s.map((async s=>{const a=s.url;return a!==t&&n.match(a)?(e.delete(s),a):null}))))).then((e=>e.filter((e=>e)))))))(o.list);o.list=n?.length?n:null}return o};function f(){const e=[];this.push=t=>{e.push(t)},this.match=t=>{if(this.force)return!0;if(t=new URL(t),this.refresh)return i(t).clean;for(let n of e)if(n.match(t))return!0;return!1}}function p(e){const t=t=>{const n=e.value;if(Array.isArray(n)){for(let e of n)if(t(e))return!0;return!1}return t(n)};this.match=(()=>{switch(e.flag){case"html":return e=>e.pathname.match(/(\/|\.html)$/);case"end":return e=>t((t=>e.href.endsWith(t)));case"begin":return e=>t((t=>e.pathname.startsWith(t)));case"str":return e=>t((t=>e.href.includes(t)));case"reg":return e=>t((t=>e.href.match(new RegExp(t,"i"))));default:throw`未知表达式：${JSON.stringify(e)}`}})()}})();